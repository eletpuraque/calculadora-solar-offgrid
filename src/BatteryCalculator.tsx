<LONG CODE FROM EARLIER STEP>